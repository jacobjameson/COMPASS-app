library(shiny)
library(ggplot2)
library(DT)
library(rdrop2)

# Dropbox setup (replace with your token)
token <- drop_auth("8o9zk0r2plkz503")

ui <- fluidPage(
  titlePanel("CSV Data Explorer"),
  sidebarLayout(
    sidebarPanel(
      selectInput("fileInput", "Select CSV File", choices = NULL),
      uiOutput("varSelect"),
      downloadButton("downloadData", "Download Data")
    ),
    mainPanel(
      DTOutput("dataTable"),
      plotOutput("dataPlot")
    )
  )
)

server <- function(input, output, session) {
  # Update CSV file choices
  observe({
    choices <- drop_dir("https://www.dropbox.com/home/Jacob%20Jameson/COMPASS%20model/Files%20from%20Zach_Dec%202023", dtoken = token)$name
    updateSelectInput(session, "fileInput", choices = choices)
  })
  
  # Variable selection UI based on selected file
  output$varSelect <- renderUI({
    req(input$fileInput)
    df <- read.csv(drop_read(input$fileInput, dtoken = token))
    checkboxGroupInput("selectedVars", "Select Variables", names(df))
  })
  
  # Display data table and plot
  filteredData <- reactive({
    req(input$fileInput, input$selectedVars)
    df <- read.csv(drop_read(input$fileInput, dtoken = token))
    df[, input$selectedVars, drop = FALSE]
  })
  
  output$dataTable <- renderDT({
    datatable(filteredData())
  })
  
  output$dataPlot <- renderPlot({
    req(input$selectedVars)
    ggplot(filteredData(), aes_string(x = input$selectedVars[1])) + 
      geom_bar() + 
      theme_minimal()
  })
  
  # Download handler
  output$downloadData <- downloadHandler(
    filename = function() { paste(input$fileInput, ".csv", sep = "") },
    content = function(file) {
      write.csv(filteredData(), file)
    }
  )
}

shinyApp(ui, server)
